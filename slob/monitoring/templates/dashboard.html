<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLOB Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-bottom: 1px solid #30363d;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #1f2937;
            border-bottom: 1px solid #30363d;
            font-weight: 600;
            color: #58a6ff;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #1f2937 0%, #161b22 100%);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
            color: #58a6ff;
        }
        .stat-label {
            color: #8b949e;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 20px;
        }
        .positive {
            color: #3fb950;
        }
        .negative {
            color: #f85149;
        }
        .table-sm td, .table-sm th {
            padding: 0.5rem;
            color: #c9d1d9;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(110, 118, 129, 0.05);
        }
        .table {
            color: #c9d1d9;
        }
        .table thead th {
            border-bottom: 1px solid #30363d;
            background-color: #161b22;
        }
        .alert-info {
            background-color: #1f6feb;
            border-color: #58a6ff;
            color: #ffffff;
        }
        .alert-warning {
            background-color: #9e6a03;
            border-color: #d29922;
            color: #ffffff;
        }
        .alert-danger {
            background-color: #da3633;
            border-color: #f85149;
            color: #ffffff;
        }
        .alert-success {
            background-color: #2ea043;
            border-color: #3fb950;
            color: #ffffff;
        }
        .text-muted {
            color: #8b949e !important;
        }
        .text-primary {
            color: #58a6ff !important;
        }
        .text-info {
            color: #58a6ff !important;
        }
        .text-success {
            color: #3fb950 !important;
        }
        .text-white {
            color: #ffffff !important;
        }
        .bg-white {
            background-color: #161b22 !important;
        }
        .sticky-top {
            background-color: #161b22 !important;
        }
        .form-control {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }
        .form-control:focus {
            background-color: #0d1117;
            border-color: #58a6ff;
            color: #c9d1d9;
        }
        .btn-outline-light:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .btn-outline-secondary {
            color: #8b949e;
            border-color: #30363d;
        }
        .btn-outline-secondary:hover {
            background-color: #30363d;
            color: #c9d1d9;
        }
        .card-body {
            color: #c9d1d9;
        }
        small {
            color: #8b949e;
        }
        strong {
            color: #c9d1d9;
        }
        h2, h3, h4, h5 {
            color: #c9d1d9;
        }
        p {
            color: #c9d1d9;
        }
        /* Table Styling */
        .table {
            color: #c9d1d9;
        }
        .table thead {
            background-color: #161b22 !important;
            border-bottom: 2px solid #30363d;
        }
        .table thead th {
            color: #8b949e !important;
            font-weight: 600;
            border-bottom: 2px solid #30363d;
            background-color: #161b22 !important;
        }
        .table thead.sticky-top {
            background-color: #161b22 !important;
        }
        .table thead.sticky-top.bg-white {
            background-color: #161b22 !important;
        }
        .table tbody td {
            color: #c9d1d9 !important;
            border-color: #30363d !important;
            background-color: transparent !important;
        }
        .table tbody tr {
            background-color: #0d1117 !important;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(110, 118, 129, 0.05) !important;
        }
        .table-striped tbody tr:nth-of-type(even) {
            background-color: #0d1117 !important;
        }
        .table-striped tbody tr:hover {
            background-color: rgba(110, 118, 129, 0.1) !important;
        }
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1f6feb 0%, #58a6ff 100%);
            border: none;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .refresh-btn:hover {
            transform: scale(1.1);
        }
        .refresh-btn:active {
            transform: scale(0.95);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinning {
            animation: spin 1s linear;
        }
        .live-price-widget {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            margin-bottom: 20px;
            border: 1px solid #30363d;
        }
        .live-price {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .price-change {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .price-change.up {
            color: #90EE90;
        }
        .price-change.down {
            color: #FFB6C1;
        }
        .price-details {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .price-detail-item {
            text-align: center;
        }
        .price-detail-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .price-detail-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        /* Profile Picture */
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #58a6ff;
            margin-right: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-bar-chart-fill"></i> SLOB Trading Dashboard
            </span>
            <div class="d-flex align-items-center gap-3">
                <span class="text-white">
                    <i class="bi bi-circle-fill text-success" id="status-indicator"></i>
                    <span id="status-text">Loading...</span>
                </span>
                <span class="text-white d-flex align-items-center">
                    <img src="{{ url_for('static', filename='logo.jpg') }}" alt="Profile" class="profile-pic">
                    {{ username }}
                </span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-label"><i class="bi bi-clock"></i> New York</div>
                    <div class="stat-value" id="ny-time" style="font-size: 1.8rem;">--:--:--</div>
                    <div class="stat-label" style="font-size: 0.75rem;" id="ny-date">---</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-label"><i class="bi bi-clock"></i> Stockholm</div>
                    <div class="stat-value" id="sthlm-time" style="font-size: 1.8rem;">--:--:--</div>
                    <div class="stat-label" style="font-size: 0.75rem;" id="sthlm-date">---</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-label">Active Setups</div>
                    <div class="stat-value" id="active-setups">-</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value" id="total-trades">-</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="win-rate">-</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-label">Total P&L</div>
                    <div class="stat-value" id="total-pnl">-</div>
                </div>
            </div>
        </div>

        <!-- Live Price Widget -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="live-price-widget">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-baseline">
                                <h2 class="mb-0 me-3">NQ</h2>
                                <div class="live-price" id="live-price">---.--</div>
                            </div>
                            <div class="price-change" id="price-change">
                                <i class="bi bi-dash"></i> <span id="change-value">--</span>
                                (<span id="change-pct">--</span>%)
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="price-details">
                                <div class="price-detail-item">
                                    <div class="price-detail-label">OPEN</div>
                                    <div class="price-detail-value" id="price-open">--</div>
                                </div>
                                <div class="price-detail-item">
                                    <div class="price-detail-label">HIGH</div>
                                    <div class="price-detail-value" id="price-high">--</div>
                                </div>
                                <div class="price-detail-item">
                                    <div class="price-detail-label">LOW</div>
                                    <div class="price-detail-value" id="price-low">--</div>
                                </div>
                                <div class="price-detail-item">
                                    <div class="price-detail-label">VOLUME</div>
                                    <div class="price-detail-value" id="price-volume">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Candlestick Chart and Candles Table -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Live Chart (Last 100 Candles)
                    </div>
                    <div class="card-body">
                        <div id="candlestickChart" style="height: 500px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-table"></i> Recent Candles
                    </div>
                    <div class="card-body p-0">
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-sm table-striped mb-0">
                                <thead class="sticky-top">
                                    <tr>
                                        <th>Time</th>
                                        <th>Close</th>
                                        <th>Vol</th>
                                    </tr>
                                </thead>
                                <tbody id="candles-tbody">
                                    <tr>
                                        <td colspan="3" class="text-muted text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Setup Pipeline -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-funnel"></i> Setup Pipeline - Live State Breakdown
                        <span class="badge bg-primary ms-2" id="pipeline-total">0 Total</span>
                    </div>
                    <div class="card-body">
                        <div id="pipelineChart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Active Setups -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-eye-fill"></i> Active Setups
                    </div>
                    <div class="card-body">
                        <div id="active-setups-list">
                            <p class="text-muted text-center">No active setups</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history"></i> Recent Trades
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm" id="trades-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Entry</th>
                                        <th>Exit</th>
                                        <th>P&L</th>
                                    </tr>
                                </thead>
                                <tbody id="trades-tbody">
                                    <tr>
                                        <td colspan="4" class="text-muted text-center">No trades yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Performance Metrics
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Wins:</strong> <span id="wins" class="positive">-</span></p>
                                <p><strong>Losses:</strong> <span id="losses" class="negative">-</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Avg Win:</strong> $<span id="avg-win">-</span></p>
                                <p><strong>Avg Loss:</strong> $<span id="avg-loss">-</span></p>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Last Update:</strong> <span id="last-update">-</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total Candles:</strong> <span id="total-candles">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ML Shadow Mode Stats -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-robot"></i> ML Shadow Mode
                    </div>
                    <div class="card-body">
                        <div id="shadow-disabled" style="display: none;">
                            <p class="text-muted">Shadow mode not enabled</p>
                        </div>
                        <div id="shadow-enabled" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Predictions:</strong> <span id="shadow-total">-</span></p>
                                    <p><strong>Agreement:</strong> <span id="shadow-agreement">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>ML Approved:</strong> <span id="shadow-approved" class="positive">-</span></p>
                                    <p><strong>ML Rejected:</strong> <span id="shadow-rejected" class="negative">-</span></p>
                                </div>
                            </div>
                            <hr>
                            <p><strong>Avg ML Probability:</strong> <span id="shadow-avg-prob">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- P&L Chart -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up-arrow"></i> P&L Chart (Last 30 Days)
                    </div>
                    <div class="card-body">
                        <canvas id="pnlChart" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Metrics -->
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-shield-check"></i> Risk Management
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <p><strong>Current Drawdown:</strong></p>
                                <h4 class="negative">$<span id="current-dd">-</span></h4>
                            </div>
                            <div class="col-md-3">
                                <p><strong>Max Drawdown:</strong></p>
                                <h4 class="negative">$<span id="max-dd">-</span></h4>
                            </div>
                            <div class="col-md-3">
                                <p><strong>Sharpe Ratio:</strong></p>
                                <h4 id="sharpe-ratio">-</h4>
                            </div>
                            <div class="col-md-3">
                                <p><strong>Profit Factor:</strong></p>
                                <h4 id="profit-factor">-</h4>
                            </div>
                        </div>
                        <hr>
                        <div class="alert alert-warning" id="circuit-breaker-warning" style="display: none;">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>CIRCUIT BREAKER ACTIVE</strong> - Trading may be paused due to maximum drawdown
                        </div>
                        <div class="alert alert-success" id="circuit-breaker-ok" style="display: none;">
                            <i class="bi bi-check-circle-fill"></i>
                            Circuit breaker: Normal (no risk threshold exceeded)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Logs -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-exclamation-circle"></i> Recent Errors
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="refreshErrorLogs()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="error-logs-container" style="max-height: 300px; overflow-y: auto;">
                            <p class="text-muted text-center">Loading error logs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="refresh-btn" id="refresh-btn" onclick="refreshData()">
        <i class="bi bi-arrow-clockwise" id="refresh-icon"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh every 30 seconds
        let autoRefreshInterval;
        let pnlChart = null;

        function updateDashboard(data) {
            // System Status
            const status = data.status || {};
            document.getElementById('status-text').textContent = status.status || 'Unknown';
            document.getElementById('last-update').textContent = status.last_update || '-';
            document.getElementById('total-candles').textContent = status.total_candles || '-';

            // Active Setups Count
            const setups = data.setups || [];
            document.getElementById('active-setups').textContent = setups.length;

            // Performance Metrics
            const metrics = data.metrics || {};
            document.getElementById('total-trades').textContent = metrics.total_trades || 0;
            document.getElementById('win-rate').textContent =
                metrics.win_rate ? (metrics.win_rate * 100).toFixed(1) + '%' : '-';
            document.getElementById('wins').textContent = metrics.wins || 0;
            document.getElementById('losses').textContent = metrics.losses || 0;
            document.getElementById('avg-win').textContent =
                metrics.avg_win ? metrics.avg_win.toFixed(2) : '-';
            document.getElementById('avg-loss').textContent =
                metrics.avg_loss ? Math.abs(metrics.avg_loss).toFixed(2) : '-';

            // Total P&L
            const pnlElement = document.getElementById('total-pnl');
            const pnl = metrics.total_pnl || 0;
            pnlElement.textContent = '$' + pnl.toFixed(2);
            pnlElement.className = 'stat-value ' + (pnl >= 0 ? 'positive' : 'negative');

            // ML Shadow Mode
            const shadow = data.shadow || {};
            if (shadow.enabled) {
                document.getElementById('shadow-disabled').style.display = 'none';
                document.getElementById('shadow-enabled').style.display = 'block';
                document.getElementById('shadow-total').textContent = shadow.total_predictions || 0;
                document.getElementById('shadow-agreement').textContent =
                    shadow.agreement_rate ? (shadow.agreement_rate * 100).toFixed(1) + '%' : '-';
                document.getElementById('shadow-approved').textContent = shadow.ml_approved || 0;
                document.getElementById('shadow-rejected').textContent = shadow.ml_rejected || 0;
                document.getElementById('shadow-avg-prob').textContent =
                    shadow.avg_ml_probability ? (shadow.avg_ml_probability * 100).toFixed(1) + '%' : '-';
            } else {
                document.getElementById('shadow-disabled').style.display = 'block';
                document.getElementById('shadow-enabled').style.display = 'none';
            }

            // Active Setups List
            const setupsList = document.getElementById('active-setups-list');
            if (setups.length === 0) {
                setupsList.innerHTML = '<p class="text-muted text-center">No active setups</p>';
            } else {
                setupsList.innerHTML = setups.map(setup => `
                    <div class="alert alert-info">
                        <strong>Setup ${setup.id ? setup.id.substring(0, 8) : 'Unknown'}</strong><br>
                        State: ${setup.state || 'Unknown'}<br>
                        ${setup.liq1_detected ? 'LIQ #1 detected' : ''}<br>
                        ${setup.liq2_detected ? 'LIQ #2 detected' : ''}
                    </div>
                `).join('');
            }

            // Recent Trades
            const trades = data.trades || [];
            const tbody = document.getElementById('trades-tbody');
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">No trades yet</td></tr>';
            } else {
                tbody.innerHTML = trades.slice(0, 10).map(trade => {
                    const pnl = trade.pnl || 0;
                    const timeStr = trade.entry_time ?
                        new Date(trade.entry_time).toLocaleString('sv-SE', {
                            timeZone: 'Europe/Stockholm',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : '-';
                    return `
                        <tr>
                            <td>${timeStr}</td>
                            <td>${trade.entry_price ? trade.entry_price.toFixed(2) : '-'}</td>
                            <td>${trade.exit_price ? trade.exit_price.toFixed(2) : '-'}</td>
                            <td class="${pnl >= 0 ? 'positive' : 'negative'}">
                                $${pnl.toFixed(2)}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Risk Metrics
            const risk = data.risk || {};
            document.getElementById('current-dd').textContent = risk.current_drawdown || '0.00';
            document.getElementById('max-dd').textContent = risk.max_drawdown || '0.00';
            document.getElementById('sharpe-ratio').textContent = risk.sharpe_ratio || '0.00';
            document.getElementById('profit-factor').textContent = risk.profit_factor || '0.00';

            // Circuit Breaker Status
            if (risk.circuit_breaker_active) {
                document.getElementById('circuit-breaker-warning').style.display = 'block';
                document.getElementById('circuit-breaker-ok').style.display = 'none';
            } else {
                document.getElementById('circuit-breaker-warning').style.display = 'none';
                document.getElementById('circuit-breaker-ok').style.display = 'block';
            }

            // P&L Chart
            const chartData = data.pnl_chart || {};
            updatePnLChart(chartData);
        }

        function updatePnLChart(chartData) {
            const ctx = document.getElementById('pnlChart');
            if (!ctx) return;

            const labels = chartData.labels || [];
            const dailyPnL = chartData.daily_pnl || [];
            const cumulativePnL = chartData.cumulative_pnl || [];

            if (pnlChart) {
                // Update existing chart
                pnlChart.data.labels = labels;
                pnlChart.data.datasets[0].data = dailyPnL;
                pnlChart.data.datasets[1].data = cumulativePnL;
                pnlChart.update();
            } else {
                // Create new chart
                pnlChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Daily P&L',
                                data: dailyPnL,
                                backgroundColor: function(context) {
                                    const value = context.raw;
                                    return value >= 0 ? 'rgba(40, 167, 69, 0.6)' : 'rgba(220, 53, 69, 0.6)';
                                },
                                borderColor: function(context) {
                                    const value = context.raw;
                                    return value >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)';
                                },
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Cumulative P&L',
                                data: cumulativePnL,
                                type: 'line',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                yAxisID: 'y1',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += '$' + context.parsed.y.toFixed(2);
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Daily P&L ($)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Cumulative P&L ($)'
                                },
                                grid: {
                                    drawOnChartArea: true
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateLivePrice() {
            fetch('/api/live_price')
                .then(response => response.json())
                .then(data => {
                    // Update price
                    document.getElementById('live-price').textContent = data.price.toFixed(2);
                    document.getElementById('price-open').textContent = data.open.toFixed(2);
                    document.getElementById('price-high').textContent = data.high.toFixed(2);
                    document.getElementById('price-low').textContent = data.low.toFixed(2);
                    document.getElementById('price-volume').textContent = data.volume.toLocaleString();

                    // Update change
                    const changeElem = document.getElementById('price-change');
                    const changeValue = document.getElementById('change-value');
                    const changePct = document.getElementById('change-pct');

                    changeValue.textContent = (data.change >= 0 ? '+' : '') + data.change.toFixed(2);
                    changePct.textContent = (data.change_pct >= 0 ? '+' : '') + data.change_pct.toFixed(2);

                    // Update styling
                    changeElem.classList.remove('up', 'down');
                    changeElem.classList.add(data.direction);

                    // Update icon
                    const icon = changeElem.querySelector('i');
                    icon.className = data.direction === 'up' ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
                })
                .catch(error => {
                    console.error('Error fetching live price:', error);
                });
        }

        function updateCandlesAndChart() {
            fetch('/api/candles?limit=60')
                .then(response => response.json())
                .then(data => {
                    const candles = data.candles || [];

                    // Update candles table (show latest 20)
                    const tbody = document.getElementById('candles-tbody');
                    if (candles.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">No candles yet</td></tr>';
                    } else {
                        const latestCandles = candles.slice(-20).reverse(); // Latest 20, reversed
                        tbody.innerHTML = latestCandles.map(candle => {
                            const time = new Date(candle.timestamp);
                            const timeStr = time.toLocaleTimeString('sv-SE', {
                                timeZone: 'Europe/Stockholm',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            return `
                                <tr>
                                    <td><small>${timeStr}</small></td>
                                    <td><strong>${candle.close.toFixed(2)}</strong></td>
                                    <td><small>${(candle.volume / 1000).toFixed(0)}k</small></td>
                                </tr>
                            `;
                        }).join('');
                    }

                    // Update candlestick chart
                    if (candles.length > 0) {
                        // Convert timestamps to Stockholm time for display
                        const stockholmTimes = candles.map(c => {
                            const date = new Date(c.timestamp);
                            return date.toLocaleString('sv-SE', {
                                timeZone: 'Europe/Stockholm',
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                        });

                        const trace = {
                            x: stockholmTimes,
                            close: candles.map(c => c.close),
                            high: candles.map(c => c.high),
                            low: candles.map(c => c.low),
                            open: candles.map(c => c.open),
                            type: 'candlestick',
                            increasing: {line: {color: '#26A69A'}},
                            decreasing: {line: {color: '#EF5350'}},
                            name: 'NQ'
                        };

                        const layout = {
                            title: '',
                            xaxis: {
                                type: 'date',
                                rangeslider: {visible: false},
                                gridcolor: '#30363d',
                                color: '#8b949e',
                                tickformat: '%H:%M',
                                nticks: 10
                            },
                            yaxis: {
                                title: 'Price',
                                autorange: true,
                                gridcolor: '#30363d',
                                color: '#8b949e'
                            },
                            margin: {l: 50, r: 50, t: 20, b: 50},
                            paper_bgcolor: '#161b22',
                            plot_bgcolor: '#0d1117',
                            font: {
                                family: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                                color: '#c9d1d9'
                            }
                        };

                        const config = {
                            responsive: true,
                            displayModeBar: true,
                            displaylogo: false,
                            modeBarButtonsToRemove: ['lasso2d', 'select2d']
                        };

                        Plotly.newPlot('candlestickChart', [trace], layout, config);
                    }
                })
                .catch(error => {
                    console.error('Error fetching candles:', error);
                });
        }

        function refreshErrorLogs() {
            fetch('/api/error_logs')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('error-logs-container');
                    const logs = data.logs || [];

                    if (logs.length === 0) {
                        container.innerHTML = '<p class="text-success text-center"><i class="bi bi-check-circle"></i> No errors found - system running smoothly!</p>';
                    } else {
                        container.innerHTML = logs.map(log => `
                            <div class="alert alert-${log.level === 'CRITICAL' ? 'danger' : 'warning'} py-2 mb-2">
                                <small>
                                    <strong>[${log.level}]</strong>
                                    ${log.message}
                                </small>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error fetching logs:', error);
                    document.getElementById('error-logs-container').innerHTML =
                        '<p class="text-danger text-center">Error loading logs</p>';
                });
        }

        function updatePipeline() {
            fetch('/api/setup_pipeline')
                .then(response => response.json())
                .then(data => {
                    const pipeline = data.pipeline || [];
                    const total = data.total || 0;

                    // Update total badge
                    document.getElementById('pipeline-total').textContent = `${total} Total`;

                    if (pipeline.length === 0) {
                        document.getElementById('pipelineChart').innerHTML =
                            '<p class="text-muted text-center">No setup data available</p>';
                        return;
                    }

                    // Prepare data for Plotly bar chart
                    const labels = pipeline.map(p => p.label);
                    const values = pipeline.map(p => p.count);
                    const colors = pipeline.map(p => p.color);

                    const trace = {
                        x: labels,
                        y: values,
                        type: 'bar',
                        marker: {
                            color: colors,
                            line: {
                                color: '#30363d',
                                width: 1
                            }
                        },
                        text: values.map(v => v > 0 ? v.toString() : ''),
                        textposition: 'outside',
                        textfont: {
                            color: '#c9d1d9',
                            size: 14
                        },
                        hovertemplate: '<b>%{x}</b><br>Count: %{y}<extra></extra>'
                    };

                    const layout = {
                        xaxis: {
                            title: 'Setup State',
                            gridcolor: '#30363d',
                            color: '#8b949e',
                            tickangle: -20
                        },
                        yaxis: {
                            title: 'Count',
                            gridcolor: '#30363d',
                            color: '#8b949e'
                        },
                        paper_bgcolor: '#161b22',
                        plot_bgcolor: '#0d1117',
                        font: {
                            family: 'Segoe UI, system-ui, sans-serif',
                            color: '#c9d1d9'
                        },
                        margin: {
                            l: 50,
                            r: 20,
                            t: 20,
                            b: 100
                        },
                        showlegend: false
                    };

                    const config = {
                        responsive: true,
                        displayModeBar: false
                    };

                    Plotly.newPlot('pipelineChart', [trace], layout, config);
                })
                .catch(error => {
                    console.error('Error fetching pipeline data:', error);
                    document.getElementById('pipelineChart').innerHTML =
                        '<p class="text-danger text-center">Error loading pipeline data</p>';
                });
        }

        function refreshData() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('spinning');

            // Fetch all data in parallel
            Promise.all([
                fetch('/api/all').then(r => r.json()),
                updateLivePrice(),
                updateCandlesAndChart(),
                updatePipeline()
            ])
                .then(([data]) => {
                    updateDashboard(data);
                    setTimeout(() => icon.classList.remove('spinning'), 1000);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('status-text').textContent = 'Error';
                    icon.classList.remove('spinning');
                });
        }

        // Update clocks
        function updateClocks() {
            const now = new Date();

            // New York time (EST/EDT)
            const nyTime = now.toLocaleTimeString('en-US', {
                timeZone: 'America/New_York',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const nyDate = now.toLocaleDateString('en-US', {
                timeZone: 'America/New_York',
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('ny-time').textContent = nyTime;
            document.getElementById('ny-date').textContent = nyDate;

            // Stockholm time (CET/CEST)
            const sthlmTime = now.toLocaleTimeString('sv-SE', {
                timeZone: 'Europe/Stockholm',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const sthlmDate = now.toLocaleDateString('sv-SE', {
                timeZone: 'Europe/Stockholm',
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('sthlm-time').textContent = sthlmTime;
            document.getElementById('sthlm-date').textContent = sthlmDate;
        }

        // Initial load
        updateClocks();
        refreshData();
        refreshErrorLogs();

        // Update clocks every second
        setInterval(updateClocks, 1000);

        // Auto-refresh every 5 seconds for live updates
        autoRefreshInterval = setInterval(function() {
            refreshData();
            refreshErrorLogs();
        }, 5000);
    </script>
</body>
</html>
