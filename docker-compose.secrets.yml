# ==============================================================================
# Docker Compose with Secrets Support (Production)
# ==============================================================================
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.secrets.yml up -d
#
# Prerequisites:
#   1. Run: ./scripts/generate_secrets.sh
#   2. Ensure secrets/ directory exists with all required files
# ==============================================================================

version: '3.8'

services:
  ib-gateway:
    secrets:
      - ib_username
      - ib_password
      - vnc_password
    environment:
      # Override with secrets
      TWS_USERID_FILE: /run/secrets/ib_username
      TWS_PASSWORD_FILE: /run/secrets/ib_password
      VNC_SERVER_PASSWORD_FILE: /run/secrets/vnc_password

  slob-bot:
    secrets:
      - ib_account
      - alpaca_api_key
      - alpaca_api_secret
      - telegram_bot_token
      - telegram_chat_id
      - smtp_password
      - redis_password
      - dashboard_secret_key
      - dashboard_password_hash
    environment:
      # Override with file-based secrets
      IB_ACCOUNT_FILE: /run/secrets/ib_account
      ALPACA_API_KEY_FILE: /run/secrets/alpaca_api_key
      ALPACA_API_SECRET_FILE: /run/secrets/alpaca_api_secret
      TELEGRAM_BOT_TOKEN_FILE: /run/secrets/telegram_bot_token
      TELEGRAM_CHAT_ID_FILE: /run/secrets/telegram_chat_id
      SMTP_PASSWORD_FILE: /run/secrets/smtp_password
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      DASHBOARD_SECRET_KEY_FILE: /run/secrets/dashboard_secret_key
      DASHBOARD_PASSWORD_HASH_FILE: /run/secrets/dashboard_password_hash

secrets:
  ib_username:
    file: ./secrets/ib_username.txt
  ib_password:
    file: ./secrets/ib_password.txt
  vnc_password:
    file: ./secrets/vnc_password.txt
  ib_account:
    file: ./secrets/ib_account.txt
  alpaca_api_key:
    file: ./secrets/alpaca_api_key.txt
  alpaca_api_secret:
    file: ./secrets/alpaca_api_secret.txt
  telegram_bot_token:
    file: ./secrets/telegram_bot_token.txt
  telegram_chat_id:
    file: ./secrets/telegram_chat_id.txt
  smtp_password:
    file: ./secrets/smtp_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  dashboard_secret_key:
    file: ./secrets/dashboard_secret_key.txt
  dashboard_password_hash:
    file: ./secrets/dashboard_password_hash.txt
